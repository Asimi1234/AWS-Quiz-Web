AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Quiz Backend with API Gateway, Lambda, DynamoDB, and JWT Auth
Parameters:
  SecretKey:
    Type: String
    Description: Secret key used for JWT authentication
Globals:
  Function:
    Timeout: 10
    Runtime: python3.11
    Environment:
      Variables:
        USER_QUIZ_TABLE: UserQuizzes
        USER_QUIZZES_TABLE: UserQuizzes
        USER_QUIZ_ATTEMPTS_TABLE: UserQuizAttempts
        ATTEMPTS_TABLE: UserQuizAttempts
        QUIZZES_TABLE: UserQuizzes
        USER_ATTEMPTS_TABLE: UserQuizAttempts
Resources:
  QuizApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors:
        AllowMethods: '''OPTIONS,GET,POST'''
        AllowHeaders: '''Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'''
        AllowOrigin: '''*'''
      Auth:
        DefaultAuthorizer: JWTAuthorizer
        AddDefaultAuthorizerToCorsPreflight: false
        Authorizers:
          JWTAuthorizer:
            FunctionArn:
              Fn::GetAtt:
              - JWTAuthorizerFunction
              - Arn
            Identity:
              Header: Authorization
  JWTAuthorizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: JWTAuthorizerFunction
      Handler: app.lambda_handler
      Environment:
        Variables:
          SECRET_KEY:
            Ref: SecretKey
    Metadata:
      SamResourceId: JWTAuthorizerFunction
  StartQuizFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: StartQuizFunction
      Handler: app.lambda_handler
      Events:
        GetQuestions:
          Type: Api
          Properties:
            Path: /start-quiz
            Method: get
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
    Metadata:
      SamResourceId: StartQuizFunction
  SubmitAnswerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SubmitAnswerFunction
      Handler: app.lambda_handler
      Events:
        Submit:
          Type: Api
          Properties:
            Path: /submit-answer
            Method: post
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
    Metadata:
      SamResourceId: SubmitAnswerFunction
  GetAnswers:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetAnswers
      Handler: app.lambda_handler
      Events:
        GetAnswersAPI:
          Type: Api
          Properties:
            Path: /get-answer
            Method: GET
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
    Metadata:
      SamResourceId: GetAnswers
  UserAttemptsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: UserAttemptsFunction
      Handler: app.lambda_handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName: QuizAttempts
      Environment:
        Variables:
          QUIZ_ATTEMPTS_TABLE: QuizAttempts
          SECRET_KEY:
            Ref: SecretKey
      Events:
        UserAttemptsGet:
          Type: Api
          Properties:
            Path: /user/attempts
            Method: get
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
        UserAttemptsPost:
          Type: Api
          Properties:
            Path: /user/attempts
            Method: post
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
    Metadata:
      SamResourceId: UserAttemptsFunction
  CheckAttemptsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: CheckAttemptsFunction
      Handler: app.lambda_handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName: QuizAttempts
      Environment:
        Variables:
          QUIZ_ATTEMPTS_TABLE: QuizAttempts
          SECRET_KEY:
            Ref: SecretKey
      Events:
        CheckAttemptsAPI:
          Type: Api
          Properties:
            Path: /check-attempts
            Method: get
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
    Metadata:
      SamResourceId: CheckAttemptsFunction
  SubmitQuizFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SubmitQuizFunction
      Handler: app.lambda_handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName: QuizAttempts
      Environment:
        Variables:
          QUIZ_ATTEMPTS_TABLE: QuizAttempts
      Events:
        SubmitQuizAPI:
          Type: Api
          Properties:
            Path: /submit-quiz
            Method: post
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
    Metadata:
      SamResourceId: SubmitQuizFunction
  LeaderboardFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: LeaderboardFunction
      Handler: app.lambda_handler
      Policies:
      - DynamoDBReadPolicy:
          TableName: QuizAttempts
      - DynamoDBReadPolicy:
          TableName: Users
      Environment:
        Variables:
          QUIZ_ATTEMPTS_TABLE: QuizAttempts
      Events:
        LeaderboardAPI:
          Type: Api
          Properties:
            Path: /leaderboard
            Method: get
            RestApiId:
              Ref: QuizApi
    Metadata:
      SamResourceId: LeaderboardFunction
  UserLoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: UserLoginFunction
      Handler: app.lambda_handler
      Policies:
      - DynamoDBReadPolicy:
          TableName: Users
      Environment:
        Variables:
          SECRET_KEY:
            Ref: SecretKey
      Events:
        UserLoginAPI:
          Type: Api
          Properties:
            Path: /login
            Method: post
            RestApiId:
              Ref: QuizApi
    Metadata:
      SamResourceId: UserLoginFunction
  UserSignupFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: UserSignupFunction
      Handler: app.lambda_handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName: Users
      Environment:
        Variables:
          SECRET_KEY:
            Ref: SecretKey
      Events:
        UserSignupAPI:
          Type: Api
          Properties:
            Path: /signup
            Method: post
            RestApiId:
              Ref: QuizApi
    Metadata:
      SamResourceId: UserSignupFunction
  RequestPasswordResetFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: RequestPasswordResetFunction
      Handler: app.lambda_handler
      Policies:
      - DynamoDBReadPolicy:
          TableName: Users
      Environment:
        Variables:
          SECRET_KEY:
            Ref: SecretKey
      Events:
        RequestPasswordResetAPI:
          Type: Api
          Properties:
            Path: /request-password-reset
            Method: post
            RestApiId:
              Ref: QuizApi
    Metadata:
      SamResourceId: RequestPasswordResetFunction
  ResetPasswordFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ResetPasswordFunction
      Handler: app.lambda_handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName: Users
      Environment:
        Variables:
          SECRET_KEY:
            Ref: SecretKey
      Events:
        ResetPasswordAPI:
          Type: Api
          Properties:
            Path: /reset-password
            Method: post
            RestApiId:
              Ref: QuizApi
    Metadata:
      SamResourceId: ResetPasswordFunction
  CheckUserExistsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: CheckUserExistsFunction
      Handler: app.lambda_handler
      Policies:
      - DynamoDBReadPolicy:
          TableName: Users
      Events:
        CheckUserExistsAPI:
          Type: Api
          Properties:
            Path: /check-user-exists
            Method: post
            RestApiId:
              Ref: QuizApi
    Metadata:
      SamResourceId: CheckUserExistsFunction
  GoogleAuthFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GoogleAuthFunction
      Handler: app.lambda_handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName: Users
      Environment:
        Variables:
          GOOGLE_CLIENT_ID: ''
          SECRET_KEY:
            Ref: SecretKey
      Events:
        GoogleAuthAPI:
          Type: Api
          Properties:
            Path: /auth/google
            Method: post
            RestApiId:
              Ref: QuizApi
    Metadata:
      SamResourceId: GoogleAuthFunction
  CreateQuizFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: user/create_quiz/app.lambda_handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName: UserQuizzes
      Runtime: python3.11
      CodeUri: CreateQuizFunction
      Timeout: 10
      Environment:
        Variables:
          USER_QUIZ_TABLE: UserQuizzes
      Events:
        CreateQuiz:
          Type: Api
          Properties:
            Path: /user/create-quiz
            Method: POST
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
    Metadata:
      SamResourceId: CreateQuizFunction
  DeleteQuizFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: user/delete_quiz/app.lambda_handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName: UserQuizzes
      Events:
        DeleteQuiz:
          Type: Api
          Properties:
            Path: /user/delete-quiz
            Method: POST
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
      CodeUri: DeleteQuizFunction
    Metadata:
      SamResourceId: DeleteQuizFunction
  GetQuizzesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: user/get_quizzes/app.lambda_handler
      Policies:
      - DynamoDBReadPolicy:
          TableName: UserQuizzes
      Events:
        GetQuizzes:
          Type: Api
          Properties:
            Path: /user/get-quizzes
            Method: GET
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
      CodeUri: GetQuizzesFunction
    Metadata:
      SamResourceId: GetQuizzesFunction
  GetQuizFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: user/get_quiz/app.lambda_handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName: UserQuizzes
      Events:
        GetQuiz:
          Type: Api
          Properties:
            Path: /user/get-quiz
            Method: GET
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
      CodeUri: GetQuizFunction
    Metadata:
      SamResourceId: GetQuizFunction
  GetQuizAttemptsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: user/get_quiz_attempts/app.lambda_handler
      Policies:
      - DynamoDBReadPolicy:
          TableName: UserQuizAttempts
      Events:
        GetQuizAttempts:
          Type: Api
          Properties:
            Path: /user/get-quiz-attempts
            Method: GET
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
      CodeUri: GetQuizAttemptsFunction
    Metadata:
      SamResourceId: GetQuizAttemptsFunction
  SubmitAnswersFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: user/submit_answers/app.lambda_handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName: UserQuizAttempts
      Events:
        SubmitAnswers:
          Type: Api
          Properties:
            Path: /user/submit-answers
            Method: POST
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
      CodeUri: SubmitAnswersFunction
    Metadata:
      SamResourceId: SubmitAnswersFunction
  GetDashboardFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: GetDashboardFunction
      Handler: app.lambda_handler
      Policies:
      - DynamoDBReadPolicy:
          TableName: UserQuizzes
      - DynamoDBReadPolicy:
          TableName: UserQuizAttempts
      Events:
        GetDashboardAPI:
          Type: Api
          Properties:
            Path: /user/dashboard
            Method: get
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
    Metadata:
      SamResourceId: GetDashboardFunction
  GetAllAttemptsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: user/get_all_attempts/app.lambda_handler
      Policies:
      - DynamoDBReadPolicy:
          TableName: UserQuizAttempts
      Events:
        GetAllAttempts:
          Type: Api
          Properties:
            Path: /user/get-all-attempts
            Method: GET
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
      CodeUri: GetAllAttemptsFunction
    Metadata:
      SamResourceId: GetAllAttemptsFunction
  UpdateQuizFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: user/update_quiz/app.lambda_handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName: UserQuizzes
      Events:
        UpdateQuiz:
          Type: Api
          Properties:
            Path: /user/update-quiz
            Method: POST
            RestApiId:
              Ref: QuizApi
            Auth:
              Authorizer: JWTAuthorizer
      CodeUri: UpdateQuizFunction
    Metadata:
      SamResourceId: UpdateQuizFunction
Outputs:
  QuizApiUrl:
    Description: API Gateway endpoint URL for Quiz API
    Value:
      Fn::Sub: https://${QuizApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-QuizApiUrl
  QuizAttemptsTableName:
    Description: DynamoDB table name for quiz attempts (existing table)
    Value: QuizAttempts
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-QuizAttemptsTableName
